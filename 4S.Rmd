---
title: |
  | Modeling transition/transversion bias
  | of nucleotide substitution over time
subtitle: |
  | Stefan Schmutz
  | January 2019

bibliography: bibliography.bib
csl: nature.csl
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(seqinr)
library(knitr)
library(kableExtra)
```

```{r read-fasta, echo=FALSE}
nt_order <- c("T", "C", "A", "G")

mt_cyb <-
  read.fasta(file = "mt-cyb-human-mouse_cDNAalignment.fasta", set.attributes = FALSE)

mt_cyb_df <-
  bind_cols("mouse" = mt_cyb$MUSMUSCULUSCYTB, "human" = mt_cyb$HOMOSAPIENSCYTB) %>%
  mutate(mouse = fct_relevel(toupper(mouse), nt_order),
         human = fct_relevel(toupper(human), nt_order))
```

## Introduction
DNA, the molecule essential for known life, consists of four building blocks. 
Those blocks (thymine (T), cytosine (C), adenine (A), guanine (G)) are called nucleotides. [@wiki:DNA]  
Since DNA evolves over time, substitutions (change of nucleotides) occur. 
For structural reasons, transitions (substitutions between A and G or T and C), 
are more likely to happen compared to transversions (all other substitutions)
in the majority of the cases [@10.1371/journal.pgen.0030022].

The aim of this work is to describe a Markov model of nucleotide substitution 
over time which consideres nucleotide- and transition/transversion-bias.  
The four nucleotides of DNA represent the four different states of the Markov model.  
Other parameters needed for the model are the initial state distribution ($\pi$) and 
state transition probabilities. Those parameters will be estimated in the next section 
and are based on a pairwise sequence alignment of human and mouse cytochrome b (MT-CYB) 
which is a mitochondrial gene [@doi:10.1056/NEJM199909303411404].

**?initial state distribution = steady-state distribution?**

## Estimations to parameterize the model
### Nucleotide frequencies

> Estimate nucleotide frequencies from the pairwise alignment of human and mouse cytochrome b gene as given in the file “mt-cyb-human- mouse_cDNAalignment.fasta”. Use these values to parameterize the model.

A way to estimate the nucleotide frequencies is to count the occurences and
divide them by the total length.  
Since we're working with a pairwise alignment without indels, the total length
of both sequences is the same (`r length(mt_cyb$HOMOSAPIENSCYTB)` nt). 
The detailed composition is listed in Table \ref{tab:nucleotide-frequencies}.  

**?These are the initial state distribution probabilities $\pi_{i}$ or equilibrium distribution $\pi$?**  
**?what's the difference between $\pi$ and $\hat{\pi}$**


```{r nucleotide-frequencies, echo=FALSE}

nt_frequencies <-
  mt_cyb_df %>%
  pivot_longer(c(mouse, human), names_to = "organism", values_to = "nucleotide") %>%
  group_by(organism, nucleotide) %>%
  summarize(count = n(),
            frequency = round(count / length(mt_cyb$HOMOSAPIENSCYTB), digits = 4))

nt_frequencies %>%
  pivot_wider(-count, names_from = "organism", values_from = "frequency") %>%
  kable(caption = "Nucleotide frequencies") %>%
  kable_styling(full_width = F, latex_options = "hold_position")

avg_frequencies <-
  nt_frequencies %>%
  group_by(nucleotide) %>%
  summarise(avg_frequency = mean(frequency)) %>%
  pull(avg_frequency)

```

We assume that the mean of this distribution is the equilibrium distribution $\pi$.  

$$\pi = (\pi_{T}, \pi_{C}, \pi_{A}, \pi_{G}) = (`r round(avg_frequencies, digits = 4)`)$$

### Transition transversion rate ratio

> Propose a simple way of estimating transition transversion rate ratio from the dataset and use this estimate for the parameterization of the model.

The numbers of the 16 possible combinations of the sequence
alignment are shown in Table \ref{tab:nucleotide-comparisons} (from mouse in rows to human in columns).

```{r nucleotide-comparisons, echo=FALSE}

nt_comparisons <-
  mt_cyb_df %>%
  group_by(mouse, human) %>%
  summarize(count = n())

nt_comparisons_matrix <-
  matrix(nt_comparisons$count, nrow = 4, byrow = TRUE, dimnames = list(nt_order, nt_order))

nt_comparisons_matrix %>%
  kable(caption = "Nucleotide comparisons (numbers)") %>%
  kable_styling(full_width = F, latex_options = "hold_position")
```

We get the frequencies (Table \ref{tab:nucleotide-comparisons-frequencies}) when the numbers are divided by the total length (`r length(mt_cyb$HOMOSAPIENSCYTB)` nt).

```{r nucleotide-comparisons-frequencies, echo=FALSE}

round(nt_comparisons_matrix / length(mt_cyb$HOMOSAPIENSCYTB), digits = 4) %>%
  kable(caption = "Nucleotide comparisons (frequencies)") %>%
  kable_styling(full_width = F, latex_options = "hold_position")
```

```{r rate-ratios, echo=FALSE}

transition_difference <-
  nt_comparisons %>%
  filter(mouse == "T" & human == "C" |
         mouse == "C" & human == "T" |
         mouse == "A" & human == "G" |
         mouse == "G" & human == "A") %>%
  pull(count) %>%
  sum() / length(mt_cyb$HOMOSAPIENSCYTB)
  
transversion_difference <-
  nt_comparisons %>%
  filter(mouse == "T" & human == "A" |
         mouse == "A" & human == "T" |
         mouse == "T" & human == "G" |
         mouse == "G" & human == "T" |
         mouse == "C" & human == "A" |
         mouse == "A" & human == "C" |
         mouse == "C" & human == "G" |
         mouse == "G" & human == "C") %>%
  pull(count) %>%
  sum() / length(mt_cyb$HOMOSAPIENSCYTB)
```

The fraction of sites with transitional differences ($S = `r round(transition_difference, digits = 4)`$)
and transversional differences ($V = `r round(transversion_difference, digits = 4)`$) can be estimated
by taking the sum of the corresponding fields from Table \ref{tab:nucleotide-comparisons-frequencies}.  
The estimate of distance ($\hat{d}$) and transition/transversion rate ratio ($\hat{\kappa}$) can now be calculated as follows:  
$$\hat{d} = $$



## (log-)likelihood
### Computing by hand

> By hand, compute the (log-)likelihood for the first 10 alignment positions given that the two sequences are separated by evolutionary distance of 0.01 expected substitutions per site.

### Computing using a program

> Write a program to compute the likelihood function of the whole alignment for the same genetic distance. Compute the likelihood for the whole alignment for several values of transition-transversion ratio around the value you estimated. Can you find a value that gives a better likelihood?

## Implementing a simulation

> Implement a simulation under your model for two sequences over an arbitrary distance t. Validate the program by simulation and show the results of you validation.